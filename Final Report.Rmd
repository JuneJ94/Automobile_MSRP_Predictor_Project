---
title: 'STAT 420: Final Project Report'
authors: "Team"
output:
  html_document:
    theme: readable
    toc: yes
  pdf_document:
    toc: yes
---


```{r}
#install.packages("mltools")
#install.packages("caret")
#install.packages("dplyr")
#install.packages("ggplots2")
library(mltools)
library(data.table)
```


**Loading dataset in R from the CSV file, and removing some columns which are not needed**
```{r}
car_data = read.csv("Cars_data.csv")
car_data = subset(car_data, select = -c(Vehicle.Style, Market.Category))

#unique(car_data$Transmission.Type)
#colnames(car_data)
#unique(car_data$Engine.Fuel.Type)
#unique(car_data$Driven_Wheels)
#unique(car_data$Vehicle.Size)
car_data$Make<-NULL
car_data$Model<- NULL
#head(car_data)

```


**Removing extreme prices less than $3000 and greater than $100,000**
```{r}


car_data_priced<-car_data[!(car_data$MSRP>100000 | car_data$MSRP<3000 ),]

range(car_data_priced$MSRP)

```


**Removing the non automatic/manual transmission types, and storing this new data in car_data_transd dataframe**
```{r}


car_data_transd<-car_data_priced[!(car_data_priced$Transmission.Type=="AUTOMATED_MANUAL" | car_data_priced$Transmission.Type=="DIRECT_DRIVE" | car_data_priced$Transmission.Type=="UNKNOWN"),]

unique(car_data_transd$Transmission.Type)

```


**Removing certain fuel types, keeping only gasoline and diesel. Storing the result in car_data_fuel dataframe**

```{r}
car_data_fuel<-car_data_transd[!(grepl("flex", car_data_transd$Engine.Fuel.Type, fixed = TRUE)
|car_data_transd$Engine.Fuel.Type=="electric" | car_data_transd$Engine.Fuel.Type=="" | car_data_transd$Engine.Fuel.Type=="natural gas"),]

unique(car_data_fuel$Engine.Fuel.Type)
```


```{r}
range(car_data_fuel$MSRP)

```


**Assigning the different types of gasoline to a single "gasoline value". Now, the only two values for fuel type will be "gasoline" and "diesel" as visible below**

```{r}
car_data_fuel$Engine.Fuel.Type[car_data_fuel$Engine.Fuel.Type == "premium unleaded (required)" ] <- "gasoline"
car_data_fuel$Engine.Fuel.Type[car_data_fuel$Engine.Fuel.Type == "regular unleaded" ] <- "gasoline"
car_data_fuel$Engine.Fuel.Type[car_data_fuel$Engine.Fuel.Type == "premium unleaded (recommended)" ] <- "gasoline"

unique(car_data_fuel$Engine.Fuel.Type)

```



**Making categorical variables factors, and adding age variable**
```{r}
car_data_factored = car_data_fuel
car_data_factored$Vehicle.Size <- factor(car_data_factored$Vehicle.Size)
car_data_factored$Transmission.Type <- factor(car_data_factored$Transmission.Type)
car_data_factored$Engine.Fuel.Type <- factor(car_data_factored$Engine.Fuel.Type)
car_data_factored$Driven_Wheels <- factor(car_data_factored$Driven_Wheels)
car_data_factored$Engine.Cylinders <- factor(car_data_factored$Engine.Cylinders)
car_data_factored$Number.of.Doors <- factor(car_data_factored$Number.of.Doors)

levels(car_data_factored$Vehicle.Size)
levels(car_data_factored$Transmission.Type)
levels(car_data_factored$Engine.Fuel.Type)
levels(car_data_factored$Driven_Wheels)
levels(car_data_factored$Engine.Cylinders)
levels(car_data_factored$Number.of.Doors)


#car_data_factored = one_hot(as.data.table(car_data_factored))

car_data_factored$ReleasedYearsAgo <- with(car_data_factored, 2020 - Year)

```



**Removing repetitive variable(s)**

```{r}
car_data_factored$Year <- NULL
```


**Modeling**

```{r}

library(dplyr)
library(ggplot2)
library(caret)
set.seed(100)
#train-test  split using 65% of the data
samplesize = round(0.65*nrow(car_data_factored), 0)
index = sample(seq_len(nrow(car_data_factored)), size = samplesize)
data_train = car_data_factored[index,]
data_test = car_data_factored[-index,]
msrp_mod = lm(MSRP ~., data_train)
summary(msrp_mod)
msrp_mod2 = lm(MSRP ~ highway.MPG + Popularity, data_test)
#summary(msrp_mod2)
#anova(msrp_mod2, msrp_mod)
```


```{r}
alias(msrp_mod)
```

**Assumptions**


```{r}
plot_func = function(model, pointcol = "blue",linecol = "green") {
  plot(fitted(model), resid(model), col = pointcol, pch = 20, xlab = "Fitted", ylab = "Residuals")
  abline(h = 0, col = linecol, lwd = 2)

}
```

```{r}
library(car)
assumption_tester = function(model) {
  par(mfrow = c(1, 2))

  plot(fitted(model), resid(model), col = "grey", pch = 20,
       xlab = "Fitted", ylab = "Residuals", main = "Fitted versus Residuals")
  abline(h = 0, col = "darkorange", lwd = 2)
  
  qqnorm(resid(model), main = "Normal Q-Q Plot", col = "darkgrey")
  qqline(resid(model), col = "dodgerblue", lwd = 2)
  
  #normality test
  print(shapiro.test(model$residuals[0:5000]))
  

  #multicollinearity
  vif = vif(model)
  print("Max VIF Value:")
  print(max(vif))
  print(vif)
  
  #Constant Variance
  plot_func(model)
  
}

```


```{r}
assumption_tester(msrp_mod)
```



**Trying Polynomial Models**
```{r}
MSRP_big_mod = lm(
  log(MSRP) ~ . + I(Engine.HP ^ 2) + I(ReleasedYearsAgo ^ 2), 
  data = data_train)

MSRP_mod_back_aic = step(MSRP_big_mod, direction = "backward", trace = 0)

summary(MSRP_mod_back_aic)$adj.r.sq

```

```{r}
n = length(resid(MSRP_big_mod))
MSRP_mod_back_bic = step(MSRP_big_mod, direction = "backward", k = log(n), trace = 0)
summary(MSRP_mod_back_bic)$adj.r.sq
is.factor(data_train$Engine.Cylinders)
```





```{r}
MSRP_all_int = lm(
  log(MSRP) ~ . + I(Engine.HP ^ 2) + I(ReleasedYearsAgo ^ 2), 
  data = data_train)

MSRP_mod_back_aic = step(MSRP_big_mod, direction = "backward", trace = 0)

summary(MSRP_mod_back_aic)$adj.r.sq

```

```{r}
n = length(resid(MSRP_big_mod))
MSRP_mod_back_bic = step(MSRP_big_mod, direction = "backward", k = log(n), trace = 0)
summary(MSRP_mod_back_bic)$adj.r.sq

```


```{r}
#summary(MSRP_mod_back_aic)
```

```{r}

assumption_tester(MSRP_mod_back_aic)
```


**Making model improvements**

```{r}
head(car_data_factored)

car_model = lm (MSRP ~ ., data = car_data_factored)
aic_back = step(car_model, direction = "back")

```

```{r}
summary(aic_back)

```



```{r}
plot( MSRP~Engine.HP, data = car_data_factored)

hist( car_data_factored$MSRP, scientific = FALSE)

```

